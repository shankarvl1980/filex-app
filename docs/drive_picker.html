<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Drive Folder Picker</title>
  <script src="https://apis.google.com/js/api.js?onload=onApiLoad" async defer></script>
</head>

<body>

<script>
  // üî• THIS LINE GOES FIRST ‚Äî proves your page is actually running
  console.log("FILEX_PICKER_PAGE_LOADED " + window.location.href);

  const DEVELOPER_KEY = "YOUR_API_KEY";
  const APP_ID = "YOUR_PROJECT_NUMBER";
  const SCOPE = ["https://www.googleapis.com/auth/drive.file"];

  function getToken() {
    const u = new URL(window.location.href);
    return u.searchParams.get("token");
  }

  function onApiLoad() {
    gapi.load("picker", { callback: createPicker });
  }

  function createPicker() {
    const token = getToken();

    // üîç Confirms token arrived
    console.log("TOKEN_LEN=" + (token ? token.length : 0));

    if (!token) {
      if (window.AndroidBridge) AndroidBridge.onCancel("Missing token");
      return;
    }

    const foldersView = new google.picker.DocsView()
      .setIncludeFolders(true)
      .setSelectFolderEnabled(true)
      .setMimeTypes("application/vnd.google-apps.folder");

    const picker = new google.picker.PickerBuilder()
      .setAppId(APP_ID)
      .setDeveloperKey(DEVELOPER_KEY)
      .setOAuthToken(token)
      .setOrigin(window.location.origin)
      .addView(foldersView)
      .setCallback(pickerCallback)
      .build();

    picker.setVisible(true);
  }

  function pickerCallback(data) {
    console.log("PICKER_ACTION=" + data.action);
    console.log("PICKER_CALLBACK_RAW=" + JSON.stringify(data));

    const Action = google.picker.Action;

    if (data.action === Action.PICKED) {
      const doc = data.docs && data.docs[0];
      if (doc && window.AndroidBridge) {
        AndroidBridge.onPickedFolder(
          String(doc.id),
          String(doc.name || doc.title || "Drive Folder")
        );
      }
    } else if (data.action === Action.CANCEL) {
      if (window.AndroidBridge) AndroidBridge.onCancel("User cancelled");
    }
  }
</script>

</body>
</html>
