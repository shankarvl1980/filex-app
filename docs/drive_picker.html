<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Drive Folder Picker</title>

  <!-- IMPORTANT: ensure onApiLoad runs only after api.js loads -->
  <script src="https://apis.google.com/js/api.js?onload=onApiLoad" async defer></script>
</head>

<body>
<script>
  const DEVELOPER_KEY = "AIzaSyDAazPfoPYllwo8hsNWIDMB1ASGiL5X_gk";
  const APP_ID = "603518003549"; // numeric
  const SCOPE = ["https://www.googleapis.com/auth/drive.file"]; // token must include this scope

  function getToken() {
    const u = new URL(window.location.href);
    return u.searchParams.get("token"); // you must load: ...privacy.html?token=ya29....
  }

  function onApiLoad() {
    // picker module
    gapi.load("picker", { callback: createPicker });
  }

  function createPicker() {
    const token = getToken();

    if (!token) {
      if (window.AndroidBridge) AndroidBridge.onCancel("Missing token in URL");
      return;
    }

    const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
      .setIncludeFolders(true)
      .setSelectFolderEnabled(true);

    const picker = new google.picker.PickerBuilder()
      .setAppId(APP_ID)
      .setDeveloperKey(DEVELOPER_KEY)
      .setOAuthToken(token)
      // CRITICAL for WebView + restricted key: origin must match your allowed domain
      .setOrigin(window.location.origin) // should be https://shankarvl1980.github.io
      .addView(view)
      .setCallback(pickerCallback)
      .build();

    picker.setVisible(true);
  }

  function pickerCallback(data) {
    const Action = google.picker.Action;

    if (data.action === Action.PICKED) {
      const doc = data.docs && data.docs[0];
      if (doc && window.AndroidBridge) {
        AndroidBridge.onPickedFolder(doc.id, doc.name || doc.title || "Drive Folder");
      }
    } else if (data.action === Action.CANCEL) {
      if (window.AndroidBridge) AndroidBridge.onCancel("User cancelled");
    }
  }
</script>
</body>
</html>
